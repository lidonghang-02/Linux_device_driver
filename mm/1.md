# Linux 内存管理

## 概述

Linux 内存管理子系统负责Linux系统中内存的分配、保护、共享、映射等管理任务，是Linux系统的核心部分之一。

## 虚拟内存

虚拟内存是一种内存管理技术，让应用程序认为自己又有连续的内存空间，实际内存可能分散在不同的物理内存位置或存储在磁盘上。

作用：
1. 进程隔离：让每个进程都有独立的内存空间，进程之间不会相互干扰
2. 内存保护：提供不同的访问权限（读、写、执行），防止非法访问
3. 内存扩展：利用程序运行局部性原理，允许进程使用超过实际物理内存的空间

## 分段机制

分段机制可以解决地址空间保护问题，其基本思想是把程序所需的内存空间的虚拟地址映射到某个物理地址空间。

分段机制将内存划为若干段，每个段有特定的起始地址和长度。在分段机制下，虚拟地址由**段选择子**和**段内偏移量**组成。

- 段选择子：一个16位的寄存器值，用来标识当前使用的段，保存在段寄存器中。它包含段的索引、描述符特权级(DPL)和表指示符(TI)。其中最重要的是段的索引，通过它可以在段表中找到段描述符，里面保存着这个段的基地址、段限长和访问权限等信息。
- 段内偏移量：段内偏移量应位于0和段限长之间，其与段基址想加可以得道物理内存地址。

	分段机制虽然有了明显的改进，但仍然以进程为单位，内存交换的效率不高，所以发明了分页机制。

## 分页机制

- 核心概念
	- 页：虚拟内存被划分为固定大小的块，一般是4KB
	- 页表：维护虚拟地址到物理地址的映射关系
	- 页帧：物理内存中与页对应的块，也叫页框或物理页面
	- TLB：一块高速缓存，用于缓存页表转换的结果，从而减少内存访问的时间。也称为页表缓存、快表等

- 多级页表：常见的是二级页表结构。在二级页表中，虚拟地址转换成物理机制需要通过两个表，第一个是页目录表(PDE)，第二个是二级页表(PTE)。

- 地址转换：在分页机制下，虚拟地址分为两部分，页号和页内偏移。页号是页表的索引，在页表中包含了物理页的基地址，其与页内偏移组合就形成了物理内存地址。

	在CPU芯片里面，使用MMU(内存管理单元)来完成地址转换和TLB的交互。
	CPU在寻址时，首先会查找TLB，如果没有找到才去查找页表。

## 段页式内存管理

- 将程序划分为多个有逻辑意义的段，如代码段、数据段、栈段等
- 对上一步划分每个段再次划分为多个页，即进一步细分

	经过上面两步，地址结构就由段号、段内页号和页内偏移三部分组成

## 部分概念

- 逻辑地址：程序使用的地址，没有被内存管理映射的地址，通常是相对于段的偏移地址。是分段机制转换前的地址。
- 线性地址：也称虚拟地址，是逻辑地址通过分段机制转换后的地址。它是MMU使用的中间地址，用于进一步通过分页机制转换成物理地址。是分页机制转换前的地址。
- 物理地址：对应物理内存中的实际位置。
